{% extends 'base.html' %}
{% load static %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
       integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
       crossorigin=""/>
{% endblock styles %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
       integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
       crossorigin=""></script>
    <script src="{% static 'common/js/map.js' %}"></script>
    <script>

        {% if center %}
            var centerLine = [{{ center.0 }}, {{ center.1 }}];
            console.log("Using passed center line");
        {% else %}
            var centerLine = [37.0902, -95.7129];
        {% endif %}

        var zoom = {{ zoom|default:6 }};

        var mapUrl = "{{ mapUrl|default:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" }}";

        {% if attribution %}
            var attribution = "{{ attribution }}";
        {% else %}
        var attribution = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';
        {% endif %}

        var maxZoom = {{ max_zoom|default:18 }};

        {% autoescape on %}
        {% for layerUrl in layerUrls %}
            layerUrls.push("{{ layerUrl }}");
        {% endfor %}
        {% endautoescape %}

        {% if layerStyle %}
            var layerStyle = {{ layerStyle }};
        {% endif %}

    </script>
{% endblock scripts %}

{% block content %}
<div id="content" class="pane" style="overflow-y: auto; height: 75vh; margin: 20px">
    <div id="mapid" style="width: {{ map_width|default:'95vw' }}; height: {{ map_height|default:'70vh' }}; margin: auto"></div>
</div>

<form action="config/ngen" method="post" id="ngen-config", name="ngen-config">
  {# Add the token to provide cross site request forgery protection #}
  {% csrf_token %}
  <input id="cat-id" name="cat-id" type="hidden" value="">
</form>

<div id="map"></div>
<script>
  $(function() {
  //var mymap = L.map('map')
  // L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  //         maxZoom: 5,
  //         attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  //         tileSize: 512,
  //         zoomOffset: -1
  //     }).addTo(mymap);
  var catchments = {{ catchments|safe }};

  var catchment_layer = L.geoJSON(catchments,
      {
        style: {color: "#999", weight: 2, fillColor: "#00ad79", fillOpacity: .6},

        onEachFeature: function (feature, layer) {
          //var popupContent = "Name:  " + feature.id + "<br>" +
          //                   "Area:  " + feature.properties.area_sqkm + "<br>" +
          //                   "Nexus: " + feature.properties.toid
          var popupContent = propertiesToHTML(feature)
          //hover popup
          layer.bindTooltip(popupContent, {closeButton: false, offset: L.point(0, -20)});
          //click popup
          //layer.bindPopup( popupContent )
          layer.on('click', function (e) {
            console.log('clicked feature: '+feature.id);
            document.forms['ngen-config']['cat-id'].value = feature.id;
            //submit form to server
            $('#ngen-config').submit()

          });
        }
      }
  )
  catchment_layer.addTo(mymap);
  mymap.fitBounds(catchment_layer.getBounds());

    });
</script>

{% endblock content %}
