# Generated by Django 4.1.3 on 2023-08-30 13:25
import typing

from django.db import migrations
from django.contrib.auth.models import User


def assign_owners_to_evaluation_definitions(apps, schema_editor):
    EvaluationDefinition = apps.get_model("evaluation_service", "EvaluationDefinition")

    all_evaluation_definitions: typing.Sequence[EvaluationDefinition] = EvaluationDefinition.objects.all()

    for definition in all_evaluation_definitions:
        possible_owners = User.objects.filter(username__icontains=definition.author)

        if possible_owners:
            definition.owner = possible_owners.first()
        else:
            # Assign it to the first superuser so they can deal with it later
            superusers = User.objects.filter(is_superuser=True)
            if superusers:
                definition.owner_id = superusers.first().id
                definition.save()


class Migration(migrations.Migration):

    dependencies = [
        ('evaluation_service', '0006_alter_evaluationdefinition_unique_together'),
    ]

    operations = [
        migrations.RunPython(assign_owners_to_evaluation_definitions)
    ]
